#============================================================================================================
#
#	スレッド管理 - レス モジュール
#	thread.res.pl
#	---------------------------------------------------------------------------
#	2004.07.21 start
#
#============================================================================================================
package	MODULE;

#------------------------------------------------------------------------------------------------------------
#
#	コンストラクタ
#	-------------------------------------------------------------------------------------
#	@param	なし
#	@return	モジュールオブジェクト
#
#------------------------------------------------------------------------------------------------------------
sub new
{
	my		$this = shift;
	my		($obj,@LOG);
	
	$obj = {
		'LOG' => \@LOG
	};
	bless($obj,$this);
	
	return $obj;
}

#------------------------------------------------------------------------------------------------------------
#
#	表示メソッド
#	-------------------------------------------------------------------------------------
#	@param	$Sys	MELKOR
#	@param	$Form	SAMWISE
#	@param	$pSys	管理システム
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub DoPrint
{
	my		$this = shift;
	my		($Sys,$Form,$pSys) = @_;
	my		($subMode,$BASE,$BBS,$DAT);
	
	require('./mordor/sauron.pl');
	$BASE = new SAURON;
	$BBS = $pSys->{'AD_BBS'};
	$DAT = $pSys->{'AD_DAT'};
	
	# 掲示板情報の読み込みとグループ設定
	if	($pSys->{'AD_BBS'} eq undef){
		require('./module/nazguls.pl');
		$BBS = new NAZGUL;
		
		$BBS->Load($Sys);
		$Sys->Set('BBS',$BBS->Get('DIR',$Form->Get('TARGET_BBS')));
		$pSys->{'SECINFO'}->SetGroupInfo($BBS->Get('DIR',$Form->Get('TARGET_BBS')));
	}
	
	# datの読み込み
	if	($pSys->{'AD_DAT'} eq undef){
		require('./module/gondor.pl');
		$DAT = new ARAGORN;
		
		$Sys->Set('KEY',$Form->Get('TARGET_THREAD'));
		my	$datPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';
		$DAT->Load($Sys,$datPath,1);
	}
	
	# 管理マスタオブジェクトの生成
	$Page		= $BASE->Create($Sys,$Form);
	$subMode	= $Form->Get('MODE_SUB');
	
	# メニューの設定
	SetMenuList($BASE,$pSys,$Sys->Get('BBS'));
	
	if		($subMode eq 'LIST'){													# レス一覧画面
		PrintResList($Page,$Sys,$Form,$DAT);
	}
	elsif	($subMode eq 'EDIT'){													# レス編集画面
		PrintResEdit($Page,$Sys,$Form,$DAT);
	}
	elsif	($subMode eq 'ABONE'){													# レス削除確認画面
		PrintResDelete($Page,$Sys,$Form,$DAT,1);
	}
	elsif	($subMode eq 'DELETE'){													# レス削除確認画面
		PrintResDelete($Page,$Sys,$Form,$DAT,0);
	}
	elsif	($subMode eq 'DELLUMP'){												# レス一括削除画面
		PrintResLumpDelete($Page,$Sys,$Form,$DAT);
	}
	elsif	($subMode eq 'COMPLETE'){												# 完了画面
		$Sys->Set('_TITLE','Process Complete');
		$BASE->PrintComplete('過去ログ処理',$this->{'LOG'});
	}
	elsif	($subMode eq 'FALSE'){													# 失敗画面
		$Sys->Set('_TITLE','Process Failed');
		$BASE->PrintError($this->{'LOG'});
	}
	
	# 掲示板・スレッド情報を設定
	$Page->HTMLInput('hidden','TARGET_BBS',$Form->Get('TARGET_BBS'));
	$Page->HTMLInput('hidden','TARGET_THREAD',$Form->Get('TARGET_THREAD'));
	
	$BASE->Print($Sys->Get('_TITLE') . ' - ' . $BBS->Get('NAME',$Form->Get('TARGET_BBS'))
					. ' - ' . $DAT->GetSubject(),3);
}

#------------------------------------------------------------------------------------------------------------
#
#	機能メソッド
#	-------------------------------------------------------------------------------------
#	@param	$Sys	MELKOR
#	@param	$Form	SAMWISE
#	@param	$pSys	管理システム
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub DoFunction
{
	my		$this = shift;
	my		($Sys,$Form,$pSys) = @_;
	my		($subMode,$err,$BBS,$DAT);
	
	require('./module/gondor.pl');
	require('./module/nazguls.pl');
	$BBS = new NAZGUL;
	$DAT = new ARAGORN;
	
	# 掲示板情報の読み込みとグループ設定
	eval{
		$BBS->Load($Sys);
		$Sys->Set('BBS',$BBS->Get('DIR',$Form->Get('TARGET_BBS')));
		$pSys->{'SECINFO'}->SetGroupInfo($BBS->Get('DIR',$Form->Get('TARGET_BBS')));
	};
	
	# datの読み込み
	eval{
		$Sys->Set('KEY',$Form->Get('TARGET_THREAD'));
		my	$datPath = $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';
		$DAT->Load($Sys,$datPath,1);
	};
	
	$subMode	= $Form->Get('MODE_SUB');
	$err		= 9999;
	
	if		($subMode eq 'EDIT'){													# レス編集
		$err = FunctionResEdit($Sys,$Form,$DAT,$this->{'LOG'});
	}
	elsif		($subMode eq 'ABONE'){												# レスあぼ〜ん
		$err = FunctionResDelete($Sys,$Form,$DAT,$this->{'LOG'},1);
	}
	elsif		($subMode eq 'DELETE'){												# レス削除
		$err = FunctionResDelete($Sys,$Form,$DAT,$this->{'LOG'},0);
	}
	
	# 処理結果表示
	if	($err){
		$pSys->{'LOGGER'}->Put($Form->Get('UserName'),"RESPONSE($subMode)",'ERROR:'.$err);
		push(@{$this->{'LOG'}},$err);
		$Form->Set('MODE_SUB','FALSE');
	}
	else{
		$pSys->{'LOGGER'}->Put($Form->Get('UserName'),"RESPONSE($subMode)",'COMPLETE');
		$Form->Set('MODE_SUB','COMPLETE');
	}
	$pSys->{'AD_BBS'} = $BBS;
	$pSys->{'AD_DAT'} = $DAT;
	$this->DoPrint($Sys,$Form,$pSys);
}

#------------------------------------------------------------------------------------------------------------
#
#	メニューリスト設定
#	-------------------------------------------------------------------------------------
#	@param	$Base	SAURON
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub SetMenuList
{
	my		($Base,$pSys,$bbs) = @_;
	
	$Base->SetMenu("レス一覧","'thread.res','DISP','LIST'");
	
	# レス削除権限のみ
	if	($pSys->{'SECINFO'}->IsAuthority($pSys->{'USER'},12,$bbs)){
		$Base->SetMenu("レス一括削除","'thread.res','DISP','DELLUMP'");
	}
	# 管理グループ権限のみ
	if	($pSys->{'SECINFO'}->IsAuthority($pSys->{'USER'},1,$bbs)){
		$Base->SetMenu("<hr>","");
		$Base->SetMenu("書き込みログ","'thread.res','DISP','LOG_THREAD_WRITE'");
	}
	$Base->SetMenu("<hr>","");
	$Base->SetMenu("掲示板管理へ戻る","'bbs.thread','DISP','LIST'");
}

#------------------------------------------------------------------------------------------------------------
#
#	レス一覧の表示
#	-------------------------------------------------------------------------------------
#	@param	$Page	ページコンテキスト
#	@param	$SYS	システム変数
#	@param	$Form	フォーム変数
#	@param	$Dat	dat変数
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub PrintResList
{
	my		($Page,$Sys,$Form,$Dat) = @_;
	my		(@elem,$resNum,$dispNum,$dispSt,$dispEd,$common,$i);
	my		($pRes,$isAbone,$isEdit);
	
	$Sys->Set('_TITLE','Res List');
	
	# 表示書式の設定
	$format = $Form->Get('DISP_FORMAT') eq '' ? '-10' : $Form->Get('DISP_FORMAT');
	($dispSt,$dispEd) = AnalyzeFormat($format,$Dat);
	
	$common	= "DoSubmit('thread.res','DISP','LIST');";
	
	$Page->Print("<center><dl><table border=0 cellspacing=2 width=100%>");
	$Page->Print("<tr><td colspan=2 align=right>表\示書式：<input type=text name=DISP_FORMAT");
	$Page->Print(" value=\"$format\"><input type=button value=\"　表\示　\" onclick=\"$common\">");
	$Page->Print("</td></tr>\n<tr><td colspan=2><hr></td></tr>\n");
	$Page->Print("<tr><th style=\"width:30\">　</th>");
	$Page->Print("<td class=\"DetailTitle\" style=\"width:300\">Contents</td></tr>\n");
	
	# 権限取得
	$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'},12,$Sys->Get('BBS'));
	$isEdit = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'},13,$Sys->Get('BBS'));
	
	# レス一覧を出力
	for	($i = $dispSt;$i < $dispEd;$i++){
		$pRes	= $Dat->Get($i);
		@elem	= split(/<>/,$$pRes);
		
		$Page->Print("<tr><td class=\"Response\" valign=top>");
		
		# レス削除権による表示抑制
		if	($isAbone){
			$Page->Print("<input type=checkbox name=RESS value=$i></td>");
		}
		else{
			$Page->Print("</td>");
		}
		$Page->Print("<td class=\"Response\"><dt>");
		
		# レス編集権による表示抑制
		if	($isEdit){
			$common = "\"javascript:SetOption('SELECT_RES','$i');";
			$common = $common . "DoSubmit('thread.res','DISP','EDIT')\"";
			$Page->Print("<a href=$common>" . ($i + 1) . "</a>");
		}
		else{
			$Page->Print('' . ($i + 1));
		}
		$Page->Print("：<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]");
		$Page->Print("：$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\n");
	}
	$Page->HTMLInput('hidden','SELECT_RES','');
	$Page->Print("<tr><td colspan=2><hr></td></tr>\n");
	
	# システム権限有無による表示抑制
	if	($isAbone){
		$common = "onclick=\"DoSubmit('thread.res','DISP'";
		$Page->Print("<tr><td colspan=2 align=right>");
		$Page->Print("<input type=button value=\"あぼ〜ん\" $common,'ABONE')\"> ");
		$Page->Print("<input type=button value=\"透明あぼ〜ん\" $common,'DELETE')\">");
		$Page->Print("</td></tr>\n");
	}
	$Page->Print("</table></dl><br>");
}

#------------------------------------------------------------------------------------------------------------
#
#	レス編集画面の表示
#	-------------------------------------------------------------------------------------
#	@param	$Page	ページコンテキスト
#	@param	$SYS	システム変数
#	@param	$Form	フォーム変数
#	@param	$Dat	dat変数
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub PrintResEdit
{
	my		($Page,$Sys,$Form,$Dat) = @_;
	my		(@elem,$pRes,$isEdit);
	
	$Sys->Set('_TITLE','Res Edit');
	
	$isEdit = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'},13,$Sys->Get('BBS'));
	$pRes	= $Dat->Get($Form->Get('SELECT_RES'));
	@elem	= split(/<>/,$$pRes);
	
	# <br>を改行に変換
	$elem[3] =~ s/<br>/\n/g;
	
	$Page->Print("<center><table border=0 cellspacing=2 width=100%>");
	$Page->Print("<tr><td colspan=2><hr></td></tr>");
	$Page->Print("<tr><td class=\"DetailTitle\">名前</td><td>");
	$Page->Print("<input type=text size=50 value=\"$elem[0]\" name=FROM></td></tr>");
	$Page->Print("<tr><td class=\"DetailTitle\">メール</td><td>");
	$Page->Print("<input type=text size=50 value=\"$elem[1]\" name=mail></td></tr>");
	$Page->Print("<tr><td class=\"DetailTitle\">日付・ID</td><td>");
	$Page->Print("<input type=text size=50 value=\"$elem[2]\" name=_DATE_></td></tr>");
	$Page->Print("<tr><td class=\"DetailTitle\">本文</td><td>");
	$Page->Print("<textarea name=MESSAGE cols=70 rows=10>$elem[3]</textarea></td></tr>");
	$Page->Print("<tr><td colspan=2><hr></td></tr>");
	
	$Page->HTMLInput('hidden','SELECT_RES',$Form->Get('SELECT_RES'));
	
	# システム権限有無による表示抑制
	if	($isEdit){
		$common = "onclick=\"DoSubmit('thread.res','FUNC'";
		$Page->Print("<tr><td colspan=2 align=right>");
		$Page->Print("<input type=button value=\"　変更　\" $common,'EDIT')\"> ");
		$Page->Print("</td></tr>\n");
	}
	$Page->Print("</table><br>");
}

#------------------------------------------------------------------------------------------------------------
#
#	レス削除確認の表示
#	-------------------------------------------------------------------------------------
#	@param	$Page	ページコンテキスト
#	@param	$SYS	システム変数
#	@param	$Form	フォーム変数
#	@param	$Dat	dat変数
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub PrintResDelete
{
	my		($Page,$Sys,$Form,$Dat,$mode) = @_;
	my		(@resSet,@elem,$pRes,$num,$common,$isAbone);
	
	$Sys->Set('_TITLE','Res Delete Confirm');
	
	# 選択レスを取得
	@resSet = $Form->GetAtArray('RESS');
	
	# 権限取得
	$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'},12,$Sys->Get('BBS'));
	
	$Page->Print("<center><dl><table border=0 cellspacing=2 width=100%>");
	$Page->Print("<tr><td>以下のレスを" . ($mode ? 'あぼ〜ん' : '削除') . "します。</td></tr>\n");
	$Page->Print("<tr><td><hr></td></tr>\n");
	$Page->Print("<tr><td class=\"DetailTitle\">Contents</td></tr>\n");
	
	# レス一覧を出力
	foreach	$num (@resSet){
		$pRes	= $Dat->Get($num);
		@elem	= split(/<>/,$$pRes);
		
		$Page->Print("<tr><td class=\"Response\"><dt>" . ($num + 1));
		$Page->Print("：<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]");
		$Page->Print("：$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\n");
		$Page->HTMLInput('hidden','RESS',$num);
	}
	$Page->Print("<tr><td><hr></td></tr>\n");
	
	# システム権限有無による表示抑制
	if	($isAbone){
		$common = "onclick=\"DoSubmit('thread.res','FUNC','";
		$common = $common . ($mode ? 'ABONE' : 'DELETE') . "')\"";
		$Page->Print("<tr><td align=right>");
		$Page->Print("<input type=button value=\"　実行　\" $common> ");
		$Page->Print("</td></tr>\n");
	}
	$Page->Print("</table></dl><br>");
}

#------------------------------------------------------------------------------------------------------------
#
#	レス一括削除の表示
#	-------------------------------------------------------------------------------------
#	@param	$Page	ページコンテキスト
#	@param	$SYS	システム変数
#	@param	$Form	フォーム変数
#	@param	$Dat	dat変数
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub PrintResLumpDelete
{
	my		($Page,$Sys,$Form,$Dat) = @_;
	my		(@resSet,@elem,$pRes,$format,$num,$common,$isAbone);
	
	$Sys->Set('_TITLE','Res Lump Delete');
	
	# 書式の解析
	$format = $Form->Get('DEL_FORMAT');
	if	($format ne ''){
		AnalyzeDeleteFormat($format,$Dat,\@resSet);
		$num = @resSet;
	}
	
	# 権限取得
	$isAbone = $Sys->Get('ADMIN')->{'SECINFO'}->IsAuthority($Sys->Get('ADMIN')->{'USER'},12,$Sys->Get('BBS'));
	
	$Page->Print("<center><dl><table border=0 cellspacing=2 width=100%>");
	$Page->Print("<tr><td colspan=2><hr></td></tr>\n");
	$Page->Print("<tr><td class=\"DetailTitle\">削除レス書式</td><td>");
	$Page->Print("<input type=text name=DEL_FORMAT size=40 value=$format></td></tr>\n");
	$Page->Print("<tr><td colspan=2><hr></td></tr>\n");
	
	if	($num > 0){
		$Page->Print("<tr><td colspan=2 class=\"DetailTitle\">Delete Contents</td></tr>");
		
		# レス一覧を出力
		foreach	$num (@resSet){
			$pRes	= $Dat->Get($num);
			@elem	= split(/<>/,$$pRes);
			
			$Page->Print("<tr><td colspan=2 class=\"Response\"><dt>" . ($num + 1));
			$Page->Print("：<font color=forestgreen><b>$elem[0]</b></font>[$elem[1]]");
			$Page->Print("：$elem[2]</dt><dd>$elem[3]<br><br></dd></td></tr>\n");
			$Page->HTMLInput('hidden','RESS',$num);
		}
		$Page->Print("<tr><td colspan=2><hr></td></tr>\n");
	}
	
	# システム権限有無による表示抑制
	if	($isAbone){
		$common = "onclick=\"DoSubmit('thread.res'";
		$Page->Print("<tr><td align=right colspan=2>");
		$Page->Print("<input type=button value=\"　確認　\" $common,'DISP','DELLUMP')\"> ");
		$Page->Print("<input type=button value=\"あぼ〜ん\" $common,'FUNC','ABONE')\"> ");
		$Page->Print("<input type=button value=\"透明あぼ〜ん\" $common,'FUNC','DELETE')\"> ");
		$Page->Print("</td></tr>\n");
	}
	$Page->Print("</table></dl><br>");
}

#------------------------------------------------------------------------------------------------------------
#
#	レス編集
#	-------------------------------------------------------------------------------------
#	@param	$Sys	システム変数
#	@param	$Form	フォーム変数
#	@param	$Dat	Dat変数
#	@param	$pLog	ログ用
#	@return	エラーコード
#
#------------------------------------------------------------------------------------------------------------
sub FunctionResEdit
{
	my		($Sys,$Form,$Dat,$pLog) = @_;
	my		(@elem,$pRes,$data);
	
	# 権限チェック
	{
		my	$SEC	= $Sys->Get('ADMIN')->{'SECINFO'};
		my	$chkID	= $Sys->Get('ADMIN')->{'USER'};
		
		if	(($SEC->IsAuthority($chkID,13,$Sys->Get('BBS'))) == 0){
			return 1000;
		}
	}
	
	# 書き込みモードで読み直す
	$Dat->ReLoad($Sys,0);
	
	$pRes		= $Dat->Get($Form->Get('SELECT_RES'));
	@elem		= split(/<>/,$$pRes);
	$elem[0]	= $Form->Get('FROM');
	$elem[1]	= $Form->Get('mail');
	$elem[2]	= $Form->Get('_DATE_');
	$elem[3]	= $Form->Get('MESSAGE');
	
	# 改行・禁則文字の変換
	$elem[3]	=~ s/\r\n|\r|\n/<br>/g;
	$elem[3]	=~ s/<>/&lt;&gt;/g;
	
	# データの連結
	$data		= join('<>',@elem);
	
	# データの設定と保存
	$Dat->Set($Form->Get('SELECT_RES'),$data);
	$Dat->Save($Sys);
	
	# ログの設定
	push(@$pLog,'番号[' . $Form->Get('SELECT_RES') . ']のレスを以下のように変更しました。');
	foreach	(@elem){
		push(@$pLog,$_);
	}
	
	return 0;
}

#------------------------------------------------------------------------------------------------------------
#
#	レス削除
#	-------------------------------------------------------------------------------------
#	@param	$Sys	システム変数
#	@param	$Form	フォーム変数
#	@param	$Dat	Dat変数
#	@param	$pLog	ログ用
#	@return	エラーコード
#
#------------------------------------------------------------------------------------------------------------
sub FunctionResDelete
{
	my		($Sys,$Form,$Dat,$pLog,$mode) = @_;
	my		(@resSet,$pRes,$abone,$path,$tm,$user,$delCnt,$num,$datPath);
	
	# 権限チェック
	{
		my	$SEC	= $Sys->Get('ADMIN')->{'SECINFO'};
		my	$chkID	= $Sys->Get('ADMIN')->{'USER'};
		
		if	(($SEC->IsAuthority($chkID,12,$Sys->Get('BBS'))) == 0){
			return 1000;
		}
	}
	
	# あぼ〜ん時は削除名を取得
	if	($mode){
		my	$Setting;
		require('./module/isildur.pl');
		$Setting = new ISILDUR;
		$Setting->Load($Sys);
		$abone	= $Setting->Get('BBS_DELETE_NAME');
	}
	
	# 各値を設定
	@resSet	= $Form->GetAtArray('RESS');
	$datPath= $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/dat/' . $Sys->Get('KEY') . '.dat';
	$path	= $Sys->Get('BBSPATH') . '/' . $Sys->Get('BBS') . '/log/del_' . $Sys->Get('KEY') . '.cgi';
	$tm		= time;
	$user	= $Form->Get('UserName');
	$delCnt	= 0;
	
	# datを書き込みモードで読み直す
	$Dat->Close();
	$Dat->Load($Sys,$datPath,0);
	
	# 削除と同時に削除ログへ削除した内容を保存する
	eval{
		open(DELLOG,">>$path");
		flock(DELLOG,2);
		binmode(DELLOG);
		foreach	$num (@resSet){
			$pRes = $Dat->Get($num - $delCnt);
			print DELLOG "$tm<>$user<>$num<>$mode<>$$pRes";
			if	($mode){
				$Dat->Set($num,"$abone<>$abone<>$abone<>$abone<>$abone\n");
			}
			else{
				$Dat->Delete($num - $delCnt);
				$delCnt ++;
			}
		}
		close(DELLOG);
		chmod($Sys->Get('PM-LOG'),$path);
	};
	
	# 保存
	$Dat->Save($Sys);
	
	# ログの設定
	$delCnt = 0;
	$abone	= '';
	push(@$pLog,'以下のレスを' . ($mode ? 'あぼ〜ん' : '削除') . 'しました。');
	foreach	(@resSet){
		if	($delCnt > 5){
			push(@$pLog,$abone);
			$abone = '';
			$delCnt = 0;
		}
		else{
			$abone .= ($_ + 1) . ',';
			$delCnt ++;
		}
	}
	push(@$pLog,$abone);
	
	return 0;
}

#------------------------------------------------------------------------------------------------------------
#
#	削除書式の解析
#	-------------------------------------------------------------------------------------
#	@param	$format	書式文字列
#	@param	$Dat	ARAGORNオブジェクト
#	@param	$pSet	結果格納配列の参照
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub AnalyzeDeleteFormat
{
	my	($format,$Dat,$pSet) = @_;
	my	(%deleteTable,@elem,$i,$st,$ed);
	
	# セパレータで分解
	@elem = split(/\,/,$format);
	
	# 1区分ずつ書式解析をしてハッシュ(二重登録防止のため)に格納
	foreach	(@elem){
		($st,$ed) = AnalyzeFormat($_,$Dat);
		if	($st != 0 || $ed != 0){
			for	($i = $st;$i < $ed;$i++){
				$deleteTable{$i} = 'true';
			}
		}
	}
	
	# 結果を配列に設定
	foreach	(sort{$a<=>$b}(keys(%deleteTable))){
		push(@$pSet,$_);
	}
}

#------------------------------------------------------------------------------------------------------------
#
#	書式の解析
#	-------------------------------------------------------------------------------------
#	@param	$format	書式文字列
#	@param	$Dat	ARAGORNオブジェクト
#	@return	(開始番号,終了番号)
#
#------------------------------------------------------------------------------------------------------------
sub AnalyzeFormat
{
	my	($format,$Dat) = @_;
	my	($start,$end,$max);
	
	# 書式エラー
	if	($format =~ /[^0-9\-l]/ || $format eq ''){
		return (0,0);
	}
	$max = $Dat->Size();
	
	# 最新n件
	if		($format =~ /l(\d+)/){
		$end	= $max;
		$start	= ($max - $1) > 0 ? ($max - $1) : 1;
	}
	# n〜m
	elsif	($format =~ /(\d+)-(\d+)/){
		$start	= $1 > $max ? $max : $1;
		$end	= $2 > $max ? $max : $2;
	}
	# n以降すべて
	elsif	($format =~ /(\d+)-/){
		$start	= $1 > $max ? $max : $1;
		$end	= $max;
	}
	# n以前すべて
	elsif	($format =~ /-(\d+)/){
		$start	= 1;
		$end	= $1 > $max ? $max : $1;
	}
	# nのみ
	elsif	($format =~ /(\d+)/){
		$start	= $1 > $max ? $max : $1;
		$end	= $1 > $max ? $max : $1;
	}
	
	# 順序正規化
	if	($start > $end){
		$max = $start;
		$start = $end;
		$end = $start;
	}
	
	return ($start - 1,$end);
}

#============================================================================================================
#	Module END
#============================================================================================================
1;
